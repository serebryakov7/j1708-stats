# J1587/J1939 Сборщик Данных

Приложение для сбора и обработки данных с шины автомобиля по протоколам SAE J1587/J1708 или J1939 с передачей через MQTT.

## Описание

Это приложение считывает данные с последовательного порта, подключенного к адаптеру автомобильной шины, разбирает сообщения согласно спецификациям SAE J1587 или J1939, и отправляет собранные данные на MQTT сервер с заданной периодичностью.

## Поддерживаемые протоколы

- **J1587/J1708** - используется в грузовых автомобилях и автобусах до 2004-2008 года
- **J1939** - современный протокол CAN, используемый в большинстве грузовых автомобилей и спецтехнике после 2004 года

## Собираемые данные

### Общие данные для обоих протоколов
- Скорость автомобиля
- Обороты двигателя (RPM)
- Температура охлаждающей жидкости
- Давление масла в двигателе
- Нагрузка на двигатель
- Уровень топлива
- Напряжение батареи
- Температура окружающего воздуха
- Общий пробег
- Активные коды неисправностей (DTC)
- Предыдущие коды неисправностей

### Дополнительные данные для J1939
- Расход топлива
- GPS координаты (если доступны)

## Использование

```bash
go build
./j1708-stats -protocol=j1587 -port=/dev/ttyUSB0 -broker=tcp://localhost:1883
```

### Параметры командной строки

- `-protocol` - используемый протокол (`j1587` или `j1939`), по умолчанию `j1587`
- `-port` - последовательный порт для подключения адаптера, по умолчанию `/dev/ttyUSB0`
- `-baud` - скорость порта в бодах, по умолчанию `9600`
- `-broker` - адрес MQTT брокера, по умолчанию `tcp://localhost:1883`
- `-topic` - топик для публикации данных, по умолчанию `vehicle/data`
- `-interval` - интервал отправки данных в MQTT, по умолчанию `10s`

## Формат данных MQTT

Данные отправляются на заданный топик в формате JSON.

### Пример данных J1587

```json
{
  "timestamp": "2023-05-19T10:00:00Z",
  "speed": 65.0,
  "engine_rpm": 1800.0,
  "coolant_temp": 85.0,
  "oil_pressure": 400.0,
  "engine_load": 75.0,
  "fuel_level": 40.0,
  "battery_voltage": 13.8,
  "ambient_temp": 20.0,
  "total_distance": 250000.0,
  "active_dtc_codes": [
    {
      "mid": 128,
      "pid": 110,
      "fmi": 3,
      "oc": 2,
      "timestamp": 1684480000,
      "description": "Модуль: Двигатель #1, Параметр ID: 110, Режим: Электрическая неисправность"
    }
  ],
  "previous_dtc_codes": []
}
```

### Пример данных J1939

```json
{
  "timestamp": "2023-05-19T10:00:00Z",
  "speed": 65.0,
  "engine_rpm": 1800.0,
  "coolant_temp": 85.0,
  "oil_pressure": 400.0,
  "engine_load": 75.0,
  "fuel_level": 40.0,
  "fuel_consumption": 26.5,
  "battery_voltage": 13.8,
  "ambient_temp": 20.0,
  "latitude": 55.755826,
  "longitude": 37.6173,
  "active_dtc_codes": [
    {
      "mid": 0,
      "pid": 190,
      "fmi": 4,
      "oc": 1,
      "timestamp": 1684480000,
      "description": "Модуль: Двигатель, SPN: 190, Режим: Напряжение ниже нормы или короткое замыкание на низкое напряжение"
    }
  ],
  "previous_dtc_codes": []
}
```

## Зависимости

- github.com/tarm/serial - для работы с последовательным портом
- github.com/eclipse/paho.mqtt.golang - для работы с MQTT

## Архитектура

Проект использует модульную архитектуру с абстракцией протокола:

```
j1708-stats/
├── main.go               - Точка входа и обработка флагов командной строки
├── internal/
│   ├── protocol/         - Интерфейс протокола
│   │   └── protocol.go
│   ├── j1587/           - Реализация протокола J1587/J1708
│   │   └── j1587.go
│   ├── j1939/           - Реализация протокола J1939
│   │   └── j1939.go
│   └── mqtt/            - Общий клиент MQTT для отправки данных
│       └── client.go
```
